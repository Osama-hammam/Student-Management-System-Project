<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>نظام إدارة الطلاب - Alpha</title>
  <style>
    :root {
      --primary: #1976d2;
      --primary-dark: #0d47a1;
      --success: #4caf50;
      --warning: #ff9800;
      --danger: #f44336;
      --info: #2196f3;
      --bg: #f5f7fa;
      --card: #ffffff;
      --border: #e0e6ed;
      --text: #2c3e50;
      --text-muted: #6c757d;
      --shadow: 0 2px 10px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 30px rgba(0,0,0,0.15);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: linear-gradient(135deg, var(--bg) 0%, #e3f2fd 100%);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
    }

    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 20px 0;
      box-shadow: var(--shadow-lg);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
    }

    .header-info {
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
    }

    .info-badge {
      background: rgba(255,255,255,0.2);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .main-content {
      padding: 30px 0;
    }

    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--card);
      border-radius: 15px;
      padding: 25px;
      box-shadow: var(--shadow);
      border-left: 4px solid var(--primary);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-lg);
    }

    .stat-card h3 {
      margin: 0 0 10px 0;
      color: var(--text-muted);
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--primary);
      margin: 0;
    }

    .stat-change {
      font-size: 12px;
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .data-section {
      background: var(--card);
      border-radius: 15px;
      overflow: hidden;
      box-shadow: var(--shadow);
      margin-bottom: 30px;
    }

    .section-header {
      background: var(--primary);
      color: white;
      padding: 20px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .section-title {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }

    .btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
      text-decoration: none;
    }

    .btn:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn.btn-success { background: var(--success); }
    .btn.btn-warning { background: var(--warning); }
    .btn.btn-danger { background: var(--danger); }
    .btn.btn-info { background: var(--info); }

    .btn.btn-success:hover { background: #388e3c; }
    .btn.btn-warning:hover { background: #f57c00; }
    .btn.btn-danger:hover { background: #d32f2f; }
    .btn.btn-info:hover { background: #1976d2; }

    .btn-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 6px;
    }

    .add-student-form {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: none;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      margin-bottom: 5px;
      font-weight: 500;
      color: var(--text);
    }

    .form-group input {
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
    }

    .report-section {
      background: var(--card);
      border-radius: 15px;
      overflow: hidden;
      box-shadow: var(--shadow);
      margin-top: 20px;
    }

    .report-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      padding: 20px;
    }

    .report-card {
      background: linear-gradient(135deg, var(--primary) 0%, var(--info) 100%);
      color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }

    .report-card h4 {
      margin: 0 0 10px 0;
      font-size: 14px;
      opacity: 0.9;
    }

    .report-card .value {
      font-size: 24px;
      font-weight: 700;
      margin: 0;
    }

    .detailed-report {
      padding: 20px;
    }

    .summary-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .summary-table th,
    .summary-table td {
      padding: 12px;
      text-align: center;
      border: 1px solid var(--border);
    }

    .summary-table th {
      background: var(--primary);
      color: white;
    }

    .summary-table .total-row {
      background: #e3f2fd;
      font-weight: 600;
    }

    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-present {
      background: #e8f5e8;
      color: var(--success);
    }

    .status-absent {
      background: #ffebee;
      color: var(--danger);
    }

    .alert {
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .alert.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .delete-btn {
      background: var(--danger);
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .delete-btn:hover {
      background: #d32f2f;
    }

    .navigation {
      text-align: center;
      margin-top: 30px;
      padding: 20px;
    }

    .nav-links {
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .nav-link {
      color: var(--primary);
      text-decoration: none;
      padding: 10px 20px;
      border: 2px solid var(--primary);
      border-radius: 25px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-link:hover {
      background: var(--primary);
      color: white;
    }
    
    .notes-box {
        margin: 20px 0;
        background: #f0f4f8;
        padding: 20px;
        border-radius: 10px;
        box-shadow: var(--shadow);
    }
    
    .notes-box h3 {
        color: var(--primary);
        margin-top: 0;
    }
    
    .notes-box textarea {
        width: 100%;
        min-height: 100px;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 10px;
        resize: vertical;
        font-size: 14px;
    }
    
    /* --- NEW MOBILE-FRIENDLY CSS --- */
    .student-list {
        display: flex;
        flex-direction: column;
        gap: 20px;
        padding: 20px;
    }

    .student-card {
        background: #f8f9fa;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 15px;
        box-shadow: var(--shadow);
        transition: transform 0.2s;
    }
    
    .student-card:hover {
        transform: translateY(-3px);
    }
    
    .student-card .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .student-card .card-header .student-name {
        font-weight: 700;
        font-size: 1.2rem;
        color: var(--primary);
    }
    
    .student-card .card-header .student-code {
        font-size: 0.9rem;
        color: var(--text-muted);
    }
    
    .student-card .card-body {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .card-field {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px 0;
        border-bottom: 1px dashed #e0e6ed;
    }

    .card-field label {
        font-weight: 500;
        color: var(--text-muted);
        flex-basis: 40%;
    }

    .card-field input, .card-field select {
        width: 60%;
        padding: 8px;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 14px;
        text-align: center;
        transition: all 0.2s;
    }
    
    .card-field input:focus, .card-field select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
    }

    .card-field .total-amount {
        font-weight: 700;
        color: var(--success);
        font-size: 1.1rem;
    }
    
    .card-actions {
        margin-top: 15px;
        text-align: right;
        display: none;
    }
    .card-actions.visible {
      display: block;
    }

  </style>
</head>
<body>
  <header class="header">
    <div class="container">
      <div class="header-content">
        <div class="logo">
          <span style="font-size: 28px;">🎓</span>
          <h1 id="pageTitle">نظام إدارة الطلاب</h1>
        </div>
        <div class="header-info">
          <div class="info-badge">
            <span>📍</span>
            <span id="locationInfo">اختر المكان</span>
          </div>
          <div class="info-badge">
            <input type="date" id="dateSelector" onchange="changeDate()" style="background: rgba(255,255,255,0.2); border: none; color: white;">
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="main-content">
    <div class="container">
      <section id="mainDashboard">
        <h2 style="text-align: center; color: var(--primary); margin-bottom: 30px;">اختر المكان والمستوى</h2>
        
        <div class="dashboard">
          <div class="stat-card" style="border-left-color: var(--info);">
            <h3>الأماكن المتاحة</h3>
            <div class="stat-value">2</div>
            <div class="places" style="margin-top: 20px; display: grid; gap: 15px;">
              <button class="btn btn-info" onclick="selectLocation('smouha')">
                <span>🏢</span> ألفا سموحة
              </button>
              <button class="btn btn-info" onclick="selectLocation('janaklis')">
                <span>🏢</span> ألفا جناكليس
              </button>
            </div>
          </div>
        </div>
      </section>

      <section id="seniorSelection" style="display: none;">
        <div class="data-section">
          <div class="section-header">
            <h2 class="section-title" id="locationTitle">اختر المستوى</h2>
            <button class="btn" onclick="showMainDashboard()" style="background: rgba(255,255,255,0.2);">
              <span>🏠</span> العودة للرئيسية
            </button>
          </div>
          <div class="table-container">
            <div class="dashboard">
              <div class="stat-card" onclick="selectSenior(1)">
                <h3>Senior 1</h3>
                <div class="stat-value">Level 1</div>
                <p style="margin: 10px 0 0 0; color: var(--text-muted);">اضغط للدخول</p>
              </div>
              <div class="stat-card" onclick="selectSenior(2)">
                <h3>Senior 2</h3>
                <div class="stat-value">Level 2</div>
                <p style="margin: 10px 0 0 0; color: var(--text-muted);">اضغط للدخول</p>
              </div>
              <div class="stat-card" onclick="selectSenior(3)">
                <h3>Senior 3</h3>
                <div class="stat-value">Level 3</div>
                <p style="margin: 10px 0 0 0; color: var(--text-muted);">اضغط للدخول</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="studentManagement" style="display: none;">
        <div class="dashboard" id="quickStats">
          <div class="stat-card">
            <h3>إجمالي الطلاب</h3>
            <div class="stat-value" id="totalStudents">0</div>
            <div class="stat-change">
              <span style="color: var(--success);">📊</span>
              مسجل في النظام
            </div>
          </div>
          <div class="stat-card">
            <h3>حضور اليوم</h3>
            <div class="stat-value" id="todayAttendance">0</div>
            <div class="stat-change">
              <span style="color: var(--success);">✅</span>
              من إجمالي الطلاب
            </div>
          </div>
          <div class="stat-card">
            <h3>إجمالي المحصول</h3>
            <div class="stat-value" id="todayRevenue">0 ج.م</div>
            <div class="stat-change">
              <span style="color: var(--warning);">💰</span>
              اليوم
            </div>
          </div>
          <div class="stat-card">
            <h3>معدل الحضور</h3>
            <div class="stat-value" id="attendanceRate">0%</div>
            <div class="stat-change">
              <span style="color: var(--info);">📈</span>
              هذا الأسبوع
            </div>
          </div>
        </div>

        <div class="data-section">
          <div class="section-header">
            <h2 class="section-title">إدارة الطلاب</h2>
            <div class="btn-group">
              <button class="btn btn-success" onclick="toggleAddStudentForm()">
                <span>➕</span> إضافة طالب جديد
              </button>
              <button class="btn btn-warning" id="toggleActionsBtn" onclick="toggleActions()">
                <span>✏️</span> تعديل وحذف الطلاب
              </button>
              <button class="btn btn-info" onclick="generateReport()">
                <span>📊</span> إنشاء تقرير
              </button>
              <button class="btn btn-warning" onclick="shareReport()">
                <span>📤</span> مشاركة التقرير
              </button>
            </div>
          </div>
          
          <div id="addStudentForm" class="add-student-form">
            <h3 style="margin-top: 0; color: var(--primary);">➕ إضافة طالب جديد</h3>
            <div class="form-row">
              <div class="form-group">
                <label>اسم الطالب:</label>
                <input type="text" id="newStudentName" placeholder="أدخل اسم الطالب" required>
              </div>
              <div class="form-group">
                <label>تليفون الطالب:</label>
                <input type="text" id="newStudentPhone" placeholder="01xxxxxxxxx" required>
              </div>
              <div class="form-group">
                <label>تليفون ولي الأمر:</label>
                <input type="text" id="newParentPhone" placeholder="01xxxxxxxxx" required>
              </div>
            </div>
            <div class="btn-group">
              <button class="btn btn-success" onclick="addNewStudent()">
                <span>✅</span> إضافة الطالب
              </button>
              <button class="btn" onclick="toggleAddStudentForm()" style="background: var(--text-muted);">
                <span>❌</span> إلغاء
              </button>
            </div>
          </div>
          
          <div class="notes-box">
              <h3>📝 ملاحظات اليوم</h3>
              <textarea id="dailyNotes" placeholder="اكتب هنا أي ملاحظات هامة عن اليوم..."></textarea>
          </div>

          <div class="student-list" id="studentsList">
            </div>
          
        </div>

        <div class="report-section" id="reportSection" style="display: none;">
          <div class="section-header">
            <h2 class="section-title">التقرير اليومي التفصيلي</h2>
            <div class="btn-group">
              <button class="btn" onclick="printReport()">
                <span>🖨️</span> طباعة التقرير
              </button>
              <button class="btn btn-warning" onclick="shareReport()">
                <span>📤</span> مشاركة التقرير
              </button>
            </div>
          </div>
          
          <div class="report-grid">
            <div class="report-card" style="background: linear-gradient(135deg, var(--success) 0%, #4caf50 100%);">
              <h4>إجمالي الحضور</h4>
              <div class="value" id="reportAttendance">0</div>
            </div>
            <div class="report-card" style="background: linear-gradient(135deg, var(--danger) 0%, #f44336 100%);">
              <h4>إجمالي الغياب</h4>
              <div class="value" id="reportAbsent">0</div>
            </div>
            <div class="report-card" style="background: linear-gradient(135deg, var(--warning) 0%, #ff9800 100%);">
              <h4>إجمالي المدفوعات</h4>
              <div class="value" id="reportTotalPaid">0 ج.م</div>
            </div>
            <div class="report-card" style="background: linear-gradient(135deg, var(--info) 0%, #2196f3 100%);">
              <h4>متوسط الدفع</h4>
              <div class="value" id="reportAvgPayment">0 ج.م</div>
            </div>
          </div>

          <div class="detailed-report">
            <h3 style="color: var(--primary); margin-bottom: 20px;">📋 تفاصيل المدفوعات</h3>
            <table class="summary-table" id="summaryTable">
              <thead>
                <tr>
                  <th>البيان</th>
                  <th>العدد/المبلغ</th>
                  <th>النسبة المئوية</th>
                  <th>التفاصيل</th>
                </tr>
              </thead>
              <tbody id="summaryBody">
                </tbody>
            </table>
            <div style="margin-top: 20px;">
                <h4 style="color: var(--text-muted);">📝 ملاحظات اليوم:</h4>
                <p id="reportNotes" style="white-space: pre-wrap;"></p>
            </div>
          </div>
        </div>

        <div class="navigation">
          <div class="nav-links">
            <a href="#" class="nav-link" onclick="showSeniorSelection()">
              <span>🔙</span> العودة لاختيار المستوى
            </a>
            <a href="#" class="nav-link" onclick="showMainDashboard()">
              <span>🏠</span> العودة للرئيسية
            </a>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    // البيانات الأساسية
    let currentLocation = '';
    let currentSenior = '';
    let studentsData = [];
    let dailyRecords = {};
    let selectedDate = new Date().toISOString().split('T')[0];

    // بيانات الطلاب التجريبية (مع المزيد من الطلاب)
    const defaultStudents = {
      smouha: {
        1: [
          { studentId: "SMH-S1-001", name: "أحمد محمد علي", studentPhone: "01012345678", parentPhone: "01234567890" },
          { studentId: "SMH-S1-002", name: "سارة أحمد محمود", studentPhone: "01198765432", parentPhone: "01011112222" },
          { studentId: "SMH-S1-003", name: "محمد حسن إبراهيم", studentPhone: "01155443322", parentPhone: "01200334455" },
          { studentId: "SMH-S1-004", name: "فاطمة عبد الرحمن", studentPhone: "01077889900", parentPhone: "01155667788" },
          { studentId: "SMH-S1-005", name: "يوسف طارق أحمد", studentPhone: "01033445566", parentPhone: "01099887766" }
        ],
        2: [
          { studentId: "SMH-S2-001", name: "مريم محمود علي", studentPhone: "01044556677", parentPhone: "01188990011" },
          { studentId: "SMH-S2-002", name: "عبد الرحمن أحمد", studentPhone: "01066778899", parentPhone: "01122334455" },
          { studentId: "SMH-S2-003", name: "نور الدين محمد", studentPhone: "01088990011", parentPhone: "01166778899" },
          { studentId: "SMH-S2-004", name: "هدى سامي حسن", studentPhone: "01099001122", parentPhone: "01144556677" }
        ],
        3: [
          { studentId: "SMH-S3-001", name: "كريم عادل محمد", studentPhone: "01011223344", parentPhone: "01199887755" },
          { studentId: "SMH-S3-002", name: "ياسمين أحمد علي", studentPhone: "01055667788", parentPhone: "01133445566" },
          { studentId: "SMH-S3-003", name: "عمر حسام الدين", studentPhone: "01077889900", parentPhone: "01177889900" }
        ]
      },
      janaklis: {
        1: [
          { studentId: "JNK-S1-001", name: "ليلى محمد أحمد", studentPhone: "01022334455", parentPhone: "01155778899" },
          { studentId: "JNK-S1-002", name: "حسام الدين علي", studentPhone: "01044556677", parentPhone: "01199001122" },
          { studentId: "JNK-S1-003", name: "رنا سامي محمد", studentPhone: "01066778899", parentPhone: "01133445566" },
          { studentId: "JNK-S1-004", name: "أسامة طارق حسن", studentPhone: "01088990011", parentPhone: "01177889900" }
        ],
        2: [
          { studentId: "JNK-S2-001", name: "دينا أحمد محمود", studentPhone: "01099112233", parentPhone: "01144556677" },
          { studentId: "JNK-S2-002", name: "تامر محمد علي", studentPhone: "01011334455", parentPhone: "01188990011" },
          { studentId: "JNK-S2-003", name: "سلمى حسن إبراهيم", studentPhone: "01055667788", parentPhone: "01122334455" }
        ],
        3: [
          { studentId: "JNK-S3-001", name: "مازن عبد الله", studentPhone: "01077889900", parentPhone: "01166778899" },
          { studentId: "JNK-S3-002", name: "غادة سمير أحمد", studentPhone: "01033445566", parentPhone: "01199887755" }
        ]
      }
    };

    let dailyNotes = '';
    let actionsVisible = false;

    // وظيفة جديدة لحفظ بيانات الطلاب بشكل دائم
    function updateStudentDataPermanent() {
      const studentsKey = `${currentLocation}_senior${currentSenior}_students`;
      localStorage.setItem(studentsKey, JSON.stringify(studentsData));
    }

    // تعديل وظيفة التحميل
    function loadFromLocalStorage() {
      // تحميل بيانات الطلاب (الأسماء والتليفونات) بشكل دائم
      const studentsKey = `${currentLocation}_senior${currentSenior}_students`;
      const storedStudents = localStorage.getItem(studentsKey);
      if (storedStudents) {
        studentsData = JSON.parse(storedStudents);
      } else {
        studentsData = [...(defaultStudents[currentLocation][currentSenior] || [])];
        updateStudentDataPermanent(); // حفظ البيانات التجريبية لأول مرة
      }
      
      // تحميل سجلات اليوم المحدد فقط
      const dailyKey = `${currentLocation}_senior${currentSenior}_${selectedDate}`;
      const storedDailyRecords = localStorage.getItem(dailyKey);
      if (storedDailyRecords) {
        const data = JSON.parse(storedDailyRecords);
        dailyRecords = data.records || {};
        dailyNotes = data.notes || '';
      } else {
        dailyRecords = {};
        dailyNotes = '';
      }
      
      document.getElementById('dailyNotes').value = dailyNotes;
    }
    
    // تعديل وظيفة الحفظ عند تغيير أي شيء
    function updateLocalStorage() {
        const dailyKey = `${currentLocation}_senior${currentSenior}_${selectedDate}`;
        localStorage.setItem(dailyKey, JSON.stringify({ records: dailyRecords, notes: dailyNotes }));
        
        // حفظ بيانات الطلاب بشكل منفصل
        updateStudentDataPermanent();
    }
    
    function changeDate() {
        selectedDate = document.getElementById('dateSelector').value;
        if (currentLocation && currentSenior) {
            loadFromLocalStorage(); // إعادة تحميل كل البيانات للتاريخ الجديد
            loadStudentsList();
            updateQuickStats();
        }
    }

    function showMainDashboard() {
      document.getElementById('mainDashboard').style.display = 'block';
      document.getElementById('seniorSelection').style.display = 'none';
      document.getElementById('studentManagement').style.display = 'none';
      document.getElementById('locationInfo').textContent = 'اختر المكان';
      document.getElementById('pageTitle').textContent = 'نظام إدارة الطلاب';
    }

    function selectLocation(location) {
      currentLocation = location;
      document.getElementById('locationInfo').textContent = location === 'smouha' ? 'ألفا سموحة' : 'ألفا جناكليس';
      document.getElementById('locationTitle').textContent = `اختر المستوى - ${location === 'smouha' ? 'ألفا سموحة' : 'ألفا جناكليس'}`;
      
      document.getElementById('mainDashboard').style.display = 'none';
      document.getElementById('seniorSelection').style.display = 'block';
      document.getElementById('studentManagement').style.display = 'none';
    }

    function showSeniorSelection() {
      document.getElementById('mainDashboard').style.display = 'none';
      document.getElementById('seniorSelection').style.display = 'block';
      document.getElementById('studentManagement').style.display = 'none';
    }

    function selectSenior(senior) {
      currentSenior = senior;
      
      document.getElementById('pageTitle').textContent = `${currentLocation === 'smouha' ? 'ألفا سموحة' : 'ألفا جناكليس'} - Senior ${senior}`;
      
      loadFromLocalStorage();
      loadStudentsList();
      updateQuickStats();
      
      document.getElementById('mainDashboard').style.display = 'none';
      document.getElementById('seniorSelection').style.display = 'none';
      document.getElementById('studentManagement').style.display = 'block';
      
      toggleActions(false);
    }

    function toggleAddStudentForm() {
      const form = document.getElementById('addStudentForm');
      if (form.style.display === 'none' || form.style.display === '') {
        form.style.display = 'block';
        document.getElementById('newStudentName').value = '';
        document.getElementById('newStudentPhone').value = '';
        document.getElementById('newParentPhone').value = '';
      } else {
        form.style.display = 'none';
      }
    }
    
    function toggleActions(forceState) {
      const actionDivs = document.querySelectorAll('.card-actions');
      const toggleBtn = document.getElementById('toggleActionsBtn');

      if (forceState === true) {
        actionsVisible = true;
      } else if (forceState === false) {
        actionsVisible = false;
      } else {
        actionsVisible = !actionsVisible;
      }
      
      actionDivs.forEach(div => {
        if (actionsVisible) {
          div.classList.add('visible');
        } else {
          div.classList.remove('visible');
        }
      });
      
      if (actionsVisible) {
        toggleBtn.innerHTML = `<span>✔️</span> تم`;
        toggleBtn.classList.add('btn-info');
        toggleBtn.classList.remove('btn-warning');
      } else {
        toggleBtn.innerHTML = `<span>✏️</span> تعديل وحذف الطلاب`;
        toggleBtn.classList.add('btn-warning');
        toggleBtn.classList.remove('btn-info');
      }
    }

    function addNewStudent() {
      const name = document.getElementById('newStudentName').value.trim();
      const studentPhone = document.getElementById('newStudentPhone').value.trim();
      const parentPhone = document.getElementById('newParentPhone').value.trim();

      if (!name || !studentPhone || !parentPhone) {
        alert('يرجى ملء جميع الحقول المطلوبة');
        return;
      }

      const prefix = currentLocation === 'smouha' ? 'SMH' : 'JNK';
      const existingIds = studentsData.map(s => s.studentId);
      let newIdNumber = 1;
      let newStudentId;
      
      do {
        newStudentId = `${prefix}-S${currentSenior}-${String(newIdNumber).padStart(3, '0')}`;
        newIdNumber++;
      } while (existingIds.includes(newStudentId));

      const newStudent = {
        studentId: newStudentId,
        name: name,
        studentPhone: studentPhone,
        parentPhone: parentPhone
      };

      studentsData.push(newStudent);
      
      updateLocalStorage();
      
      loadStudentsList();
      updateQuickStats();
      
      toggleAddStudentForm();
      
      showSuccessMessage(`تم إضافة الطالب ${name} بنجاح بالكود ${newStudentId}`);
    }

    function deleteStudent(studentId) {
      if (confirm('هل أنت متأكد من حذف هذا الطالب؟\nسيتم حذف جميع بياناته نهائياً')) {
        studentsData = studentsData.filter(s => s.studentId !== studentId);
        
        // حذف سجلات الطالب من كل التواريخ
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.includes(currentLocation) && key.includes(`senior${currentSenior}`) && key.includes(studentId)) {
            localStorage.removeItem(key);
          }
        }
        
        updateStudentDataPermanent(); // حفظ قائمة الطلاب المحدثة
        
        loadStudentsList();
        updateQuickStats();
        
        showSuccessMessage('تم حذف الطالب بنجاح');
      }
    }

    function updateStudentData(studentId, field, value) {
      const student = studentsData.find(s => s.studentId === studentId);
      if (student) {
        student[field] = value;
        updateStudentDataPermanent(); // حفظ بيانات الطالب بشكل دائم
      }
    }

    function loadStudentsList() {
      const listContainer = document.getElementById('studentsList');
      listContainer.innerHTML = '';

      studentsData.forEach(student => {
        const recordKey = `${student.studentId}-${selectedDate}`;
        const existingRecord = dailyRecords[recordKey] || {
          attendance: false,
          sessionFee: 50,
          bookletFee: 0
        };

        const card = document.createElement('div');
        card.className = 'student-card';
        card.innerHTML = `
          <div class="card-header">
            <div class="student-name">
              <input type="text" value="${student.name}" class="editable-field" 
                     onchange="updateStudentData('${student.studentId}', 'name', this.value)" />
            </div>
            <div class="student-code">${student.studentId}</div>
          </div>
          <div class="card-body">
            <div class="card-field">
              <label>تليفون الطالب:</label>
              <input type="text" value="${student.studentPhone}" class="editable-field" 
                     onchange="updateStudentData('${student.studentId}', 'studentPhone', this.value)" />
            </div>
            <div class="card-field">
              <label>تليفون ولي الأمر:</label>
              <input type="text" value="${student.parentPhone}" class="editable-field" 
                     onchange="updateStudentData('${student.studentId}', 'parentPhone', this.value)" />
            </div>
            <div class="card-field">
              <label>الحضور:</label>
              <select onchange="updateCalculations()" data-student="${student.studentId}">
                <option value="yes" ${existingRecord.attendance ? 'selected' : ''}>✅ حاضر</option>
                <option value="no" ${!existingRecord.attendance ? 'selected' : ''}>❌ غائب</option>
              </select>
            </div>
            <div class="card-field">
              <label>رسوم الحصة:</label>
              <input type="number" value="${existingRecord.sessionFee}" min="0" onchange="updateCalculations()" data-student="${student.studentId}" data-field="sessionFee" />
            </div>
            <div class="card-field">
              <label>رسوم البوكليت:</label>
              <input type="number" value="${existingRecord.bookletFee}" min="0" onchange="updateCalculations()" data-student="${student.studentId}" data-field="bookletFee" />
            </div>
            <div class="card-field">
              <label>الإجمالي:</label>
              <span class="total-amount" id="total-${student.studentId}">
                ${(existingRecord.sessionFee + existingRecord.bookletFee).toFixed(2)} ج.م
              </span>
            </div>
            <div class="card-actions">
              <button class="delete-btn btn-small" onclick="deleteStudent('${student.studentId}')" title="حذف الطالب">
                🗑️ حذف الطالب
              </button>
            </div>
          </div>
        `;
        listContainer.appendChild(card);
      });
      
      document.getElementById('dailyNotes').value = dailyNotes;
      document.getElementById('dailyNotes').addEventListener('input', () => {
        dailyNotes = document.getElementById('dailyNotes').value;
        updateLocalStorage();
      });

      updateCalculations();
      toggleActions(actionsVisible);
    }

    function updateCalculations() {
      const cards = document.querySelectorAll('.student-card');
      
      cards.forEach(card => {
        const studentId = card.querySelector('.student-code').textContent;
        const attendanceSelect = card.querySelector('select');
        const sessionFeeInput = card.querySelector('input[data-field="sessionFee"]');
        const bookletFeeInput = card.querySelector('input[data-field="bookletFee"]');
        const totalAmountSpan = card.querySelector(`.total-amount`);
        
        const attendance = attendanceSelect.value === 'yes';
        const sessionFee = parseFloat(sessionFeeInput.value) || 0;
        const bookletFee = parseFloat(bookletFeeInput.value) || 0;
        
        const total = sessionFee + bookletFee;
        totalAmountSpan.textContent = `${total.toFixed(2)} ج.م`;
        
        const recordKey = `${studentId}-${selectedDate}`;
        dailyRecords[recordKey] = {
          attendance: attendance,
          paidToday: total,
          sessionFee: sessionFee,
          bookletFee: bookletFee
        };
      });

      updateQuickStats();
      updateLocalStorage();
    }

    function updateQuickStats() {
      const totalStudents = studentsData.length;
      let todayAttendance = 0;
      let todayRevenue = 0;
      
      studentsData.forEach(student => {
        const recordKey = `${student.studentId}-${selectedDate}`;
        if (dailyRecords[recordKey] && dailyRecords[recordKey].attendance) {
          todayAttendance++;
          todayRevenue += dailyRecords[recordKey].paidToday || 0;
        }
      });

      document.getElementById('totalStudents').textContent = totalStudents;
      document.getElementById('todayAttendance').textContent = todayAttendance;
      document.getElementById('todayRevenue').textContent = `${todayRevenue.toFixed(2)} ج.م`;
      
      const attendanceRate = totalStudents > 0 ? (todayAttendance / totalStudents * 100).toFixed(0) : 0;
      document.getElementById('attendanceRate').textContent = `${attendanceRate}%`;
    }

    // --- وظيفة التصدير الجديدة التي تحتوي على كل التفاصيل ---
    function shareReport() {
        const reportData = generateReportData();
        const dateFormatted = new Date(selectedDate).toLocaleDateString('ar-EG', { day: 'numeric', month: 'long', year: 'numeric' });

        // تجهيز نص التقرير (الملخص)
        let shareText = `تقرير الطلاب: ${currentLocation === 'smouha' ? 'ألفا سموحة' : 'ألفا جناكليس'} - Senior ${currentSenior}\n`;
        shareText += `التاريخ: ${dateFormatted}\n\n`;
        shareText += `📝 ملاحظات اليوم:\n${dailyNotes}\n\n`;
        shareText += `📊 إحصائيات الحضور:\n`;
        shareText += `- إجمالي الطلاب: ${studentsData.length}\n`;
        shareText += `- الحضور: ${reportData.presentCount}\n`;
        shareText += `- الغياب: ${reportData.absentCount}\n\n`;
        shareText += `💰 إحصائيات المدفوعات:\n`;
        shareText += `- رسوم الحصة: ${reportData.totalSessionFee.toFixed(2)} ج.م\n`;
        shareText += `- رسوم البوكليت: ${reportData.totalBookletFee.toFixed(2)} ج.م\n`;
        shareText += `- الإجمالي الكلي: ${reportData.totalRevenue.toFixed(2)} ج.م\n`;

        // إضافة تفاصيل كل طالب
        shareText += `\n--- تفاصيل الطلاب ---\n\n`;
        studentsData.forEach(student => {
            const recordKey = `${student.studentId}-${selectedDate}`;
            const record = dailyRecords[recordKey] || {};
            const attendanceStatus = record.attendance ? "حاضر ✅" : "غائب ❌";
            const sessionFee = (record.sessionFee || 0).toFixed(2);
            const bookletFee = (record.bookletFee || 0).toFixed(2);
            const totalPaid = (record.paidToday || 0).toFixed(2);
            
            shareText += `* ${student.name} (${student.studentId})\n`;
            shareText += `  - الحضور: ${attendanceStatus}\n`;
            if (record.attendance) {
                shareText += `  - رسوم الحصة: ${sessionFee} ج.م\n`;
                shareText += `  - رسوم البوكليت: ${bookletFee} ج.م\n`;
                shareText += `  - الإجمالي: ${totalPaid} ج.م\n\n`;
            } else {
                shareText += `  - لم يتم دفع رسوم.\n\n`;
            }
        });
        
        // التحقق من دعم المتصفح لميزة المشاركة
        if (navigator.share) {
            navigator.share({
                title: 'تقرير الطلاب',
                text: shareText
            }).catch(error => console.error('Error sharing:', error));
        } else {
            // حل بديل للمتصفحات التي لا تدعم الميزة
            alert('خاصية المشاركة غير مدعومة في متصفحك. يمكنك نسخ التقرير أدناه يدوياً.\n\n' + shareText);
        }
    }
    // --- نهاية وظيفة التصدير الجديدة ---
    
    function generateReportData() {
        const studentsInClass = studentsData.length;
        let presentCount = 0;
        let absentCount = 0;
        let totalRevenue = 0;
        let totalSessionFee = 0;
        let totalBookletFee = 0;

        studentsData.forEach(student => {
            const recordKey = `${student.studentId}-${selectedDate}`;
            const record = dailyRecords[recordKey] || {};
            if (record.attendance) {
                presentCount++;
                totalRevenue += record.paidToday || 0;
                totalSessionFee += record.sessionFee || 0;
                totalBookletFee += record.bookletFee || 0;
            } else {
                absentCount++;
            }
        });

        const presentPercentage = studentsInClass > 0 ? ((presentCount / studentsInClass) * 100).toFixed(2) : 0;
        const absentPercentage = studentsInClass > 0 ? ((absentCount / studentsInClass) * 100).toFixed(2) : 0;

        return {
            presentCount,
            absentCount,
            totalRevenue,
            totalSessionFee,
            totalBookletFee,
            presentPercentage,
            absentPercentage
        };
    }

    function generateReport() {
      document.getElementById('reportSection').style.display = 'block';
      const reportData = generateReportData();
      
      document.getElementById('reportAttendance').textContent = reportData.presentCount;
      document.getElementById('reportAbsent').textContent = reportData.absentCount;
      document.getElementById('reportTotalPaid').textContent = `${reportData.totalRevenue.toFixed(2)} ج.م`;
      document.getElementById('reportAvgPayment').textContent = reportData.presentCount > 0 ? `${(reportData.totalRevenue / reportData.presentCount).toFixed(2)} ج.م` : '0 ج.م';
      document.getElementById('reportNotes').textContent = dailyNotes;

      const summaryBody = document.getElementById('summaryBody');
      summaryBody.innerHTML = '';
      
      const presentRow = document.createElement('tr');
      presentRow.innerHTML = `
        <td>عدد الحضور</td>
        <td>${reportData.presentCount}</td>
        <td>${reportData.presentPercentage}%</td>
        <td>-</td>
      `;
      summaryBody.appendChild(presentRow);

      const absentRow = document.createElement('tr');
      absentRow.innerHTML = `
        <td>عدد الغياب</td>
        <td>${reportData.absentCount}</td>
        <td>${reportData.absentPercentage}%</td>
        <td>-</td>
      `;
      summaryBody.appendChild(absentRow);
      
      const sessionFeeRow = document.createElement('tr');
      sessionFeeRow.innerHTML = `
        <td>إجمالي رسوم الحصة</td>
        <td>${reportData.totalSessionFee.toFixed(2)} ج.م</td>
        <td>-</td>
        <td>-</td>
      `;
      summaryBody.appendChild(sessionFeeRow);

      const bookletFeeRow = document.createElement('tr');
      bookletFeeRow.innerHTML = `
        <td>إجمالي رسوم البوكليت</td>
        <td>${reportData.totalBookletFee.toFixed(2)} ج.م</td>
        <td>-</td>
        <td>-</td>
      `;
      summaryBody.appendChild(bookletFeeRow);
      
      const totalPaidRow = document.createElement('tr');
      totalPaidRow.className = 'total-row';
      totalPaidRow.innerHTML = `
        <td>الإجمالي الكلي</td>
        <td>${reportData.totalRevenue.toFixed(2)} ج.م</td>
        <td>-</td>
        <td>إجمالي المبلغ المحصّل من رسوم الحصص والبوكليت.</td>
      `;
      summaryBody.appendChild(totalPaidRow);

    }
    
    function printReport() {
      const content = document.getElementById('reportSection').innerHTML;
      const originalBody = document.body.innerHTML;
      document.body.innerHTML = `
        <div style="direction: rtl; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px;">
          ${content}
        </div>
      `;
      window.print();
      document.body.innerHTML = originalBody;
      location.reload();
    }

    function showSuccessMessage(message) {
      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert success';
      alertDiv.innerHTML = `<span>✅</span> ${message}`;
      document.body.appendChild(alertDiv);
      setTimeout(() => {
        alertDiv.remove();
      }, 3000);
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('dateSelector').value = selectedDate;
      showMainDashboard();
    });
  </script>
</body>
</html>